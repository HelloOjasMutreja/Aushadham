<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aushadham</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom transition for section visibility */
        .section-fade {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .section-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        .section-visible {
            opacity: 1;
            transform: scale(1);
            position: static;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4 transition-colors duration-500">

<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md transition-all duration-500 overflow-hidden">
    <div id="container-content" class="relative">

        <!-- Start Section -->
        <div id="start-section" class="section-fade section-visible p-6 sm:p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100 mt-2"> Aushadham</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Please describe your main symptom to begin.</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="symptom-input" placeholder="e.g., Stomach ache, Headache" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
                <textarea id="description-input" placeholder="Optional: Briefly describe how you feel..." rows="3" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition no-scrollbar"></textarea>
                <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed disabled:scale-100">
                    <span class="btn-text">Start Assessment</span>
                    <svg class="loader-spinner animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Question Section -->
        <div id="question-section" class="section-fade section-hidden p-6 sm:p-8">
            <div class="progress-bar w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                <div id="progress-bar-fill" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <div id="question-card">
                <h2 id="question-text" class="text-xl font-semibold mb-5 text-center text-slate-800 dark:text-slate-100 min-h-[60px]"></h2>
                <div id="options-container" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>

        <!-- Report Section -->
        <div id="report-section" class="section-fade section-hidden p-6 sm:p-8">
            <div class="text-center mb-6">
                <svg class="mx-auto h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100 mt-2">Assessment Complete</h2>
            </div>
            <div id="report-content" class="space-y-4 text-sm"></div>
            <button id="restart-btn" class="mt-8 w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">Start New Assessment</button>
        </div>

        <!-- Error Message Display -->
        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative m-4" role="alert">
            <strong class="font-bold">Error: </strong>
            <span class="block sm:inline" id="error-message">Something went wrong.</span>
        </div>
    </div>
</div>

<script>
    // --- DOM Elements ---
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const symptomInput = document.getElementById('symptom-input');
    const descriptionInput = document.getElementById('description-input');
    
    const startSection = document.getElementById('start-section');
    const questionSection = document.getElementById('question-section');
    const reportSection = document.getElementById('report-section');
    
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const reportContent = document.getElementById('report-content');
    
    const errorBanner = document.getElementById('error-banner');
    const errorMessage = document.getElementById('error-message');

    // --- State ---
    let sessionId = null;
    const API_BASE_URL = 'https://aushadham.onrender.com';

    // --- UI Control Functions ---
    const showSection = (sectionToShow) => {
        [startSection, questionSection, reportSection].forEach(section => {
            if (section.id === sectionToShow) {
                section.classList.remove('section-hidden');
                section.classList.add('section-visible');
            } else {
                section.classList.add('section-hidden');
                section.classList.remove('section-visible');
            }
        });
    };

    const setLoading = (button, isLoading) => {
        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.loader-spinner');
        button.disabled = isLoading;
        if (isLoading) {
            btnText.textContent = 'Processing...';
            spinner.classList.remove('hidden');
        } else {
            btnText.textContent = 'Start Assessment';
            spinner.classList.add('hidden');
        }
    };

    const showError = (message) => {
        errorMessage.textContent = message || 'An unexpected error occurred.';
        errorBanner.classList.remove('hidden');
        // Hide error after 5 seconds
        setTimeout(() => {
            errorBanner.classList.add('hidden');
        }, 5000);
    };

    // --- API Call Wrapper ---
    const apiCall = async (endpoint, body) => {
        try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'API request failed');
            }
            return data;
        } catch (error) {
            console.error(`API Error on ${endpoint}:`, error);
            showError(error.message);
            return null; // Return null to indicate failure
        }
    };

    // --- Core Application Logic ---
    const startQuestionnaire = async () => {
        const symptom = symptomInput.value.trim();
        const description = descriptionInput.value.trim();
        if (!symptom) {
            showError('Please enter your main symptom to begin.');
            return;
        }

        setLoading(startBtn, true);
        const data = await apiCall('start_questionnaire', { symptom, description });
        setLoading(startBtn, false);

        if (data) {
            sessionId = data.session_id;
            showSection('question-section');
            displayQuestion(data.question);
        }
    };

    const submitAnswer = async (answer, action = 'next') => {
        if (!sessionId) return;
        
        // Visually disable all buttons to prevent double-clicks
        const buttons = optionsContainer.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
        
        const data = await apiCall('submit_answer', { session_id: sessionId, answer, action });
        
        if (data) {
            if (data.completed) {
                showReport();
            } else {
                displayQuestion(data.question);
            }
        } else {
            // Re-enable buttons if API call fails
            buttons.forEach(btn => btn.disabled = false);
        }
    };

    const displayQuestion = (question) => {
        questionText.textContent = question.question;
        optionsContainer.innerHTML = ''; // Clear previous options

        question.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.className = "col-span-2 sm:col-span-1 bg-slate-200 dark:bg-slate-700 hover:bg-blue-500 dark:hover:bg-blue-600 hover:text-white dark:text-slate-200 font-semibold py-3 px-4 rounded-lg transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-wait";
            btn.onclick = () => submitAnswer(opt, 'next');
            optionsContainer.appendChild(btn);
        });
        
        // Add special action buttons
        const actions = [{ text: 'Back', action: 'previous' }, { text: 'Skip', action: 'skip' }];
        actions.forEach(item => {
             const btn = document.createElement('button');
             btn.textContent = item.text;
             btn.className = "col-span-1 bg-slate-500 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 ease-in-out text-sm disabled:opacity-50 disabled:cursor-wait";
             btn.onclick = () => submitAnswer(item.action === 'skip' ? 'Skipped' : '', item.action);
             optionsContainer.appendChild(btn);
        });

        progressBarFill.style.width = `${question.progress}%`;
    };

    const showReport = async () => {
        const data = await apiCall('get_report', { session_id: sessionId });

        if (data) {
            showSection('report-section');
            const { report } = data;
            
            let html = `
                <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                    <h3 class="font-semibold text-slate-800 dark:text-slate-100">Symptom Summary</h3>
                    <p class="text-slate-600 dark:text-slate-300">${report.symptom}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                         <h3 class="font-semibold text-slate-800 dark:text-slate-100">Possible Severity</h3>
                         <p class="font-bold text-lg text-blue-500">${report.severity}</p>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                         <h3 class="font-semibold text-slate-800 dark:text-slate-100">Urgency Level</h3>
                         <p class="font-bold text-lg text-amber-500">${report.urgency}</p>
                    </div>
                </div>
            `;
            
            const createList = (title, items) => {
                if (!items || items.length === 0) return '';
                return `
                    <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 dark:text-slate-100 mb-2">${title}</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-600 dark:text-slate-300">
                            ${items.map(item => `<li>${typeof item === 'object' ? `${item.name}: <span class="text-slate-500 dark:text-slate-400">${item.purpose}</span>` : item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            };

            html += createList('Recommendations', report.recommendations);
            html += createList('Suggested Medications', report.suggested_medications);

            reportContent.innerHTML = html;
        }
    };

    // --- Event Listeners ---
    startBtn.addEventListener('click', startQuestionnaire);
    restartBtn.addEventListener('click', () => location.reload());

</script>

</body>
</html>
